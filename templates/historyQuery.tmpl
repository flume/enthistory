{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "historyQuery" }}
// Code generated by enthistory, DO NOT EDIT.
	{{- $pkg := base $.Config.Package }}
	{{- template "header" $ }}
import (
    "context"
    "time"

    {{- range $n := $.Nodes }}
        {{- $name := $n.Name }}
        {{- $history := hasSuffix $name "History" }}
        {{- if $history }}
        "{{ $.Config.Package }}/{{ lower $n.Name }}"
        {{- end }}
    {{- end }}
)

	{{ range $n := $.Nodes }}
	    {{ $name := $n.Name }}

	    {{ $history := hasSuffix $name "History" }}
	    {{ if $history }}
	    {{ else }}
            {{ range $h := $.Nodes }}
                {{ $sameNodeType := hasPrefix $h.Name (printf "%sHistory" $n.Name) }}
                {{ if $sameNodeType }}
                    func ({{ $n.Receiver }} *{{ $n.Name }}) History() *{{ $h.QueryName }}  {
                        historyClient := New{{ $h.Name }}Client({{ $n.Receiver }}.config)
                        return historyClient.Query().Where({{ lower $h.Name }}.Ref({{ $n.Receiver }}.ID))
                    }

                    func ({{ $h.Receiver }} *{{ $h.Name }}) Next(ctx context.Context) (*{{ $h.Name }}, error) {
                    	client := New{{ $h.Name }}Client({{ $h.Receiver }}.config)
                    	return client.Query().
                    		Where(
                    			{{ lower $h.Name }}.Ref({{ $h.Receiver }}.Ref),
                    			{{ lower $h.Name }}.HistoryTimeGT({{ $h.Receiver }}.HistoryTime),
                    		).
                    		Order(Asc({{ lower $h.Name }}.FieldHistoryTime)).
                    		First(ctx)
                    }

                    func ({{ $h.Receiver }} *{{ $h.Name }}) Prev(ctx context.Context) (*{{ $h.Name }}, error) {
                        client := New{{ $h.Name }}Client({{ $h.Receiver }}.config)
                        return client.Query().
                            Where(
                                {{ lower $h.Name }}.Ref({{ $h.Receiver }}.Ref),
                                {{ lower $h.Name }}.HistoryTimeLT({{ $h.Receiver }}.HistoryTime),
                            ).
                            Order(Desc({{ lower $h.Name }}.FieldHistoryTime)).
                            First(ctx)
                    }

                    func ({{ receiver $h.QueryName }} *{{ $h.QueryName }}) Earliest(ctx context.Context) (*{{ $h.Name }}, error)  {
                        return {{ receiver $h.QueryName }}.
                                    Order(Asc({{ lower $h.Name }}.FieldHistoryTime)).
                                    First(ctx)
                    }

                    func ({{ receiver $h.QueryName }} *{{ $h.QueryName }}) Latest(ctx context.Context) (*{{ $h.Name }}, error)  {
                        return {{ receiver $h.QueryName }}.
                                    Order(Desc({{ lower $h.Name }}.FieldHistoryTime)).
                                    First(ctx)
                    }

                    func ({{ receiver $h.QueryName }} *{{ $h.QueryName }}) AsOf(ctx context.Context, time time.Time) (*{{ $h.Name }}, error)  {
                        return {{ receiver $h.QueryName }}.
                                    Where({{ lower $h.Name }}.HistoryTimeLTE(time)).
                                    Order(Desc({{ lower $h.Name }}.FieldHistoryTime)).
                                    First(ctx)
                    }

                    func ({{ $h.Receiver }} *{{ $h.Name }}) Restore(ctx context.Context) (*{{ $n.Name }}, error) {
                        client := New{{ $n.Name }}Client({{ $h.Receiver }}.config)
                        return client.
                            UpdateOneID({{ $h.Receiver }}.Ref).
                        {{- range $f := $n.Fields }}
                        {{- if not $f.Immutable }}
                            Set{{ if $f.Nillable }}Nillable{{ end }}{{ $f.StructField }}({{ $h.Receiver }}.{{ pascal $f.Name }}).
                        {{- end }}
                        {{- end }}
                            Save(ctx)
                    }
                {{ end }}
            {{ end }}
        {{ end }}
	{{ end }}
{{ end }}
