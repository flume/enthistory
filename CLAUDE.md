# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Project Is

enthistory is an extension for the [ent](https://entgo.io) ORM that auto-generates history/audit tables for tracking entity changes (INSERT, UPDATE, DELETE). It integrates with ent's code generation pipeline.

## Build & Development Commands

```bash
make fmt          # Format code (goimports with -local github.com/flume)
make lint         # Lint root package and _examples
make test         # Run integration tests (cd _examples && go test ./.)
make generate     # Regenerate example code then format

# Run unit tests only (root package)
go test ./

# Run a single test
go test -run TestHistoryFieldsWithAnonFuncDefault ./

# Run integration tests directly
cd _examples && go test -run TestEntHistoryBasic ./.
```

Go version: 1.25+ (see go.mod). CI uses golangci-lint v2.4.

## Architecture

The project uses a **two-phase code generation** approach:

### Phase 1: Schema Generation (`Generate()` in `generate.go`)
- Called from the user's `entc.go` file before `entc.Generate()`
- Loads user schemas via `entc.LoadGraph()`, then uses AST manipulation (`internal/schemast/`) to create `*_history.go` schema files in the user's schema directory
- Each history schema gets automatic fields: `history_time`, `operation` (enum: INSERT/UPDATE/DELETE), `ref` (FK to original entity), and optionally `updated_by`
- Configurable via functional options: `WithUpdatedBy`, `WithHistoryTimeIndex`, `WithInheritIdType`, `WithTriggers`, `WithNillableFields`, `WithImmutableFields`, `WithReverseEdge`

### Phase 2: Extension (`HistoryExtension` in `extension.go`)
- Implements `entc.Extension` interface, registered via `entc.Extensions()`
- Uses embedded Go templates (`templates/`) to generate:
  - `historyFromMutation.tmpl` — `CreateHistoryFrom{Create,Update,Delete}` methods on mutations
  - `historyQuery.tmpl` — Query helpers: `History()`, `Latest()`, `Earliest()`, `AsOf()`, `Diff()`, `Next()`, `Prev()`, `Restore()`
  - `client.tmpl` — `WithHistory()` method on Client that registers mutation hooks
  - `auditing.tmpl` — Optional `Audit()` method (enabled via `WithAuditing()`)

### Hook System (`hook.go`)
- Generic hook factories: `HistoryTriggerInsert[T]()`, `HistoryTriggerUpdate[T]()`, `HistoryTriggerDelete[T]()`
- Hooks intercept ent mutations and call the generated `CreateHistoryFrom*` methods
- The `Mutation` interface defines the contract generated code must satisfy

### Internal Packages
- `internal/schemast/` — Vendored/modified from `entgo.io/contrib`. Handles Go AST parsing, manipulation, and printing to inject new schema files without manual editing.

## Key Files

| File | Purpose |
|------|---------|
| `generate.go` | Main code generation: schema loading, field construction, AST mutation |
| `extension.go` | Ent extension: template registration, config annotation |
| `hook.go` | Generic mutation hooks for history tracking |
| `annotations.go` | `enthistory.Annotations{}` for per-schema customization |
| `opType.go` | OpType enum (INSERT/UPDATE/DELETE) with SQL driver + GraphQL support |
| `template.go` | Template helper functions (FuncMap) |
| `_examples/basic/ent/entc.go` | Reference integration showing both phases |

## Testing

- **Unit tests** (`generate_test.go`): Test field generation logic with various ID types (int, UUID, mixins, anonymous/named func defaults)
- **Integration tests** (`_examples/enthistory_*_test.go`): Full end-to-end tests using in-memory SQLite via `enttest`. Cover create/update/delete tracking, history queries, restore, diffing, and auditing
- Examples in `_examples/` are complete ent projects: `basic`, `custompaths`, `graphql`, `without_updatedby`, `updateby_uuid`, `uuidmixinid`

## Go Workspace

The project uses `go.work` to link the root module and `_examples/` as a workspace. The examples import the local `github.com/flume/enthistory` module.

## Important Caveats

- History tables do not track ent edges (relationships) — only fields
- Enum fields require `Values()` not `NamedValues()` for history compatibility
- The `ref` field intentionally has no FK constraint to allow DELETE history records (the original entity is gone when the delete hook runs)
- Generated history schema files are prefixed with `Code generated by enthistory, DO NOT EDIT.`
